---
title: 推荐引擎优化
author: kbaroni
ms.author: kbaroni
ms.date: 07/18/2018
ms.topic: article
ms.service: industry
description: 如何重用和优化用 R 语言编写的推荐应用程序。 依赖 Azure VM 上的 Machine Learning Server。
ms.openlocfilehash: bce6d7df548e7bd80d73495dc0bec642817d8641
ms.sourcegitcommit: 76f2862adbec59311b5888e043a120f89dc862af
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 11/03/2018
ms.locfileid: "51654254"
---
# <a name="optimize-and-reuse-an-existing-recommendation-system"></a><span data-ttu-id="64b88-104">优化和重用现有推荐系统</span><span class="sxs-lookup"><span data-stu-id="64b88-104">Optimize and reuse an existing recommendation system</span></span>  

<span data-ttu-id="64b88-105">本文介绍了如何成功地重用和改进用 R 语言编写的现有推荐系统。此过程的关键是，Microsoft Machine Learning Server 中内置的 MicrosoftML 库与 RevoScaleR 库的并行度。</span><span class="sxs-lookup"><span data-stu-id="64b88-105">This document describes the process of successfully reusing and improving an existing recommendation system written in R. The key to this was the parallelism of the MicrosoftML and RevoScaleR libraries built into Microsoft Machine Learning Server.</span></span>

## <a name="recommendation-systems-and-r"></a><span data-ttu-id="64b88-106">推荐系统和 R</span><span class="sxs-lookup"><span data-stu-id="64b88-106">Recommendation systems and R</span></span>

<span data-ttu-id="64b88-107">对于零售商，了解消费者偏好和购买历史记录可提升自己的竞争优势。</span><span class="sxs-lookup"><span data-stu-id="64b88-107">For a retailer, understanding consumer preferences and purchasing history is a competitive advantage.</span></span> <span data-ttu-id="64b88-108">多年来，零售商一直在结合使用此类数据和机器学习，以确定与消费者相关的产品，并提供个性化购物体验。</span><span class="sxs-lookup"><span data-stu-id="64b88-108">Retailers have been using such data for years, in combination with machine learning, to identify products relevant to the consumer and deliver a personalized shopping experience.</span></span> <span data-ttu-id="64b88-109">这种方法称为“产品推荐”，可为零售商带来重要收入源。</span><span class="sxs-lookup"><span data-stu-id="64b88-109">The approach is called **product recommendation** and it generates a significant revenue stream for retailers.</span></span> <span data-ttu-id="64b88-110">推荐系统有助于回答以下问题：这位顾客接下来将会观看什么电影？这位顾客可能会对其他什么服务感兴趣？这位顾客希望去哪儿度假？</span><span class="sxs-lookup"><span data-stu-id="64b88-110">Recommendation systems help answer questions like: *What movie will this person watch next? What additional services is this customer likely to be interested in? Where will this customer want to vacation?*</span></span>
<span data-ttu-id="64b88-111">最近，一位客户想要知道：消费者（订阅者）会续订合同吗？</span><span class="sxs-lookup"><span data-stu-id="64b88-111">A recent customer wanted to know: *Will consumers (subscribers) renew their contracts?*</span></span> <span data-ttu-id="64b88-112">这位客户的现有推荐系统会预测订阅者续订合同的概率。</span><span class="sxs-lookup"><span data-stu-id="64b88-112">The customer had an existing recommendation model that would forecast the probability of a subscriber renewing a contract.</span></span> <span data-ttu-id="64b88-113">在预测生成后，系统会应用额外处理，以将响应分类为“是”、“否”或“可能”。</span><span class="sxs-lookup"><span data-stu-id="64b88-113">Once the forecast was generated, additional processing was applied to classify a response into a yes, no, or maybe.</span></span> <span data-ttu-id="64b88-114">然后，模型响应被集成到呼叫中心业务流程中。</span><span class="sxs-lookup"><span data-stu-id="64b88-114">The model response was then integrated into a call center business process.</span></span> <span data-ttu-id="64b88-115">此流程启用了服务代理，以向消费者提供个性化推荐。</span><span class="sxs-lookup"><span data-stu-id="64b88-115">That process enabled a service agent to deliver a personalized recommendation to the consumer.</span></span>  
<span data-ttu-id="64b88-116">这位客户的很多早期分析产品都已内置到[编程语言 R](https://docs.microsoft.com/machine-learning-server/rebranding-microsoft-r-server) 中，包括作为推荐系统核心的机器学习模型。</span><span class="sxs-lookup"><span data-stu-id="64b88-116">Many of this customer’s early analytic products were built in the [programming language R](https://docs.microsoft.com/machine-learning-server/rebranding-microsoft-r-server), including the machine learning model at the core of their recommendation system.</span></span> <span data-ttu-id="64b88-117">随着订阅者群扩增，数据要求和计算要求也越来越高，</span><span class="sxs-lookup"><span data-stu-id="64b88-117">As their subscriber base has grown, so have the data and compute requirements.</span></span> <span data-ttu-id="64b88-118">以至于推荐工作负载现在非常缓慢且处理效率低下。</span><span class="sxs-lookup"><span data-stu-id="64b88-118">So much so, the recommendation workload is now painfully slow and cumbersome to process.</span></span> <span data-ttu-id="64b88-119">现在，这位客户正逐渐将 Python 纳入自己的分析产品策略。</span><span class="sxs-lookup"><span data-stu-id="64b88-119">Now Python is increasingly a part of their analytic product strategy.</span></span> <span data-ttu-id="64b88-120">但近期内必须要保留 R 投资，并找到更高效的开发和部署流程。</span><span class="sxs-lookup"><span data-stu-id="64b88-120">But for the near term, they need to preserve their R investment and find a more efficient development and deployment process.</span></span> <span data-ttu-id="64b88-121">难题是如何使用 Azure 功能优化现有方法。</span><span class="sxs-lookup"><span data-stu-id="64b88-121">The challenge was to optimize the existing approach using capabilities in Azure.</span></span> <span data-ttu-id="64b88-122">首先，我们执行了一项任务，以提供和验证推荐工作负载的概念证明技术堆栈。</span><span class="sxs-lookup"><span data-stu-id="64b88-122">We embarked on a task to provide—and validate—a proof-of-concept technology stack for the recommendation workload.</span></span> <span data-ttu-id="64b88-123">下文总结了可用于类似项目的常规方法。</span><span class="sxs-lookup"><span data-stu-id="64b88-123">Here we summarize a general approach that can be used for similar projects.</span></span>  

## <a name="design-goals"></a><span data-ttu-id="64b88-124">设计目标</span><span class="sxs-lookup"><span data-stu-id="64b88-124">Design goals</span></span>

<span data-ttu-id="64b88-125">关键优先级是重新设计和自动运行模型工作流，这可带来以下几项优势：</span><span class="sxs-lookup"><span data-stu-id="64b88-125">A key priority was to redesign and automate the model workflow to provide several advantages:</span></span>

- <span data-ttu-id="64b88-126">缩短模型开发周期和创新时间。</span><span class="sxs-lookup"><span data-stu-id="64b88-126">Faster model development cycles and faster time-to-innovate.</span></span> <span data-ttu-id="64b88-127">当数据准备和模型开发周期高效时，可增加试验量。</span><span class="sxs-lookup"><span data-stu-id="64b88-127">When data preparation and model development cycles are efficient, the volume of experiments can increase.</span></span>  
- <span data-ttu-id="64b88-128">通过新数据的更频繁重新定型周期，提供更准确的模型结果和更优质的推荐。</span><span class="sxs-lookup"><span data-stu-id="64b88-128">More accurate model results and better recommendations through more frequent retraining cycles on fresh data.</span></span>
- <span data-ttu-id="64b88-129">概念证明 (POC) 实现的可扩展性更高，可应用于整个生产环境。</span><span class="sxs-lookup"><span data-stu-id="64b88-129">A more scalable proof-of-concept (POC) implementation—one that would work in full production.</span></span>
- <span data-ttu-id="64b88-130">通过自动执行开发、测试和部署流程，缩短投产时间。</span><span class="sxs-lookup"><span data-stu-id="64b88-130">Faster time to production by automating the processes between development, test, and deployment.</span></span> <span data-ttu-id="64b88-131">自动化还可以减少运营错误和延隔时间。</span><span class="sxs-lookup"><span data-stu-id="64b88-131">Automation also reduces operational errors and lag times.</span></span>  

## <a name="requirements"></a><span data-ttu-id="64b88-132">要求</span><span class="sxs-lookup"><span data-stu-id="64b88-132">Requirements</span></span>

<span data-ttu-id="64b88-133">工作流重新设计的要求如下：</span><span class="sxs-lookup"><span data-stu-id="64b88-133">The workflow redesign had the following requirements:</span></span>

- <span data-ttu-id="64b88-134">利用团队当前掌握的 R 技能和专业知识。</span><span class="sxs-lookup"><span data-stu-id="64b88-134">Leverage the team’s existing R skills and expertise.</span></span>
- <span data-ttu-id="64b88-135">在有意义的情况下重用代码。</span><span class="sxs-lookup"><span data-stu-id="64b88-135">Reuse code where it made sense.</span></span>
- <span data-ttu-id="64b88-136">将订阅者数据存储在数据库中，以便轻松快速地将此类数据集成到模型定型和重新定型流程中。</span><span class="sxs-lookup"><span data-stu-id="64b88-136">Store subscriber data in a database to be easily and quickly integrated into the model training and retraining process.</span></span>
- <span data-ttu-id="64b88-137">通过 Web 应用程序接口调用模型重新定型和评分。</span><span class="sxs-lookup"><span data-stu-id="64b88-137">Invoke model retraining and scoring through a web app interface.</span></span>
- <span data-ttu-id="64b88-138">使用 Azure Active Directory 在 Web 前端进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="64b88-138">Use Azure Active Directory for authentication on the web front end.</span></span>

## <a name="technology-stack"></a><span data-ttu-id="64b88-139">技术堆栈</span><span class="sxs-lookup"><span data-stu-id="64b88-139">Technology stack</span></span>

<span data-ttu-id="64b88-140">此项目的管道需要使用多种技术和工具，并以下列四个方面为中心：</span><span class="sxs-lookup"><span data-stu-id="64b88-140">The pipeline for this project required multiple technologies and tools and centered around four areas:</span></span>

1. <span data-ttu-id="64b88-141">订阅者数据的暂留和可访问性。</span><span class="sxs-lookup"><span data-stu-id="64b88-141">Persistence and accessibility of subscriber data.</span></span>
2. <span data-ttu-id="64b88-142">模型开发、定型和选择。</span><span class="sxs-lookup"><span data-stu-id="64b88-142">Development, training, and selection of models.</span></span>  
3. <span data-ttu-id="64b88-143">模型部署和运营化。</span><span class="sxs-lookup"><span data-stu-id="64b88-143">Model deployment and operationalization.</span></span>
4. <span data-ttu-id="64b88-144">使用 Web 应用程序来调用评分和模型重新定型。</span><span class="sxs-lookup"><span data-stu-id="64b88-144">Use of a web application to invoke scoring and model re-training.</span></span>

<span data-ttu-id="64b88-145">下面更详细地介绍了管道图中的技术组件。</span><span class="sxs-lookup"><span data-stu-id="64b88-145">The technology components in the pipeline diagram are discussed in more detail below.</span></span>

![优化体系结构](assets/recommendation-engine-optimization/recommendation-architecture.png)

### <a name="microsoft-machine-learning-server"></a><span data-ttu-id="64b88-147">Microsoft 机器学习服务器</span><span class="sxs-lookup"><span data-stu-id="64b88-147">Microsoft Machine Learning Server</span></span>

<span data-ttu-id="64b88-148">选择 R 工作负载的主要原因是 [RevoScaleR](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/revoscaler) 和 Microsoft ML。</span><span class="sxs-lookup"><span data-stu-id="64b88-148">The primary reason for selecting R workloads: **[RevoScaleR](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/revoscaler)** and **Microsoft ML**.</span></span> <span data-ttu-id="64b88-149">这些包随附的函数在整个代码中广泛使用，以导入数据、创建分类模型并将模型部署到生产环境中。</span><span class="sxs-lookup"><span data-stu-id="64b88-149">The functions included with these packages were used extensively throughout the code to import the data, create the classification models, and deploy them into production.</span></span>
<span data-ttu-id="64b88-150">MLS 部署在 Azure 中的两个 Linux 虚拟机上：一个配置为用于“开发”，另一个配置为用于“运营”。</span><span class="sxs-lookup"><span data-stu-id="64b88-150">MLS was deployed on two Linux virtual machines in Azure: one configured for “development” and one configured for “operations.”</span></span> <span data-ttu-id="64b88-151">开发 VM 预配有更多的内存和处理能力，以便促进定型和测试数百个模型。</span><span class="sxs-lookup"><span data-stu-id="64b88-151">The development VM was provisioned with significantly more memory and processing power to facilitate the training and testing of hundreds of models.</span></span> <span data-ttu-id="64b88-152">它还托管了 RStudio Server，以便远程用户能够轻松访问 RStudio IDE。</span><span class="sxs-lookup"><span data-stu-id="64b88-152">It also hosted RStudio Server to provide easy access to an RStudio IDE for remote users.</span></span> <span data-ttu-id="64b88-153">运营服务器配置在较小的 VM 上，包含托管可通过 REST API 从 Web 应用程序调用的 R 模型所需的附加扩展。</span><span class="sxs-lookup"><span data-stu-id="64b88-153">The operations server was configured on a smaller VM with the additional extensions necessary to host R models that were callable from a web application through REST APIs.</span></span>

### <a name="rstudio-server"></a><span data-ttu-id="64b88-154">RStudio Server</span><span class="sxs-lookup"><span data-stu-id="64b88-154">RStudio Server</span></span>

<span data-ttu-id="64b88-155">[RStudio Server](https://www.rstudio.com/products/rstudio/#Server) 是 Linux 应用程序，用于为远程客户端或笔记本电脑客户端提供基于浏览器的接口。</span><span class="sxs-lookup"><span data-stu-id="64b88-155">**[RStudio Server](https://www.rstudio.com/products/rstudio/#Server)** is a Linux application that provides a browser-based interface for remote or laptop clients.</span></span> <span data-ttu-id="64b88-156">它在端口 8787 上运行，并且在 Azure VM 上创建有网络安全规则后可用于远程连接。</span><span class="sxs-lookup"><span data-stu-id="64b88-156">It runs on port 8787 and is available to remote connections once a network security rule is created on the Azure VM.</span></span> <span data-ttu-id="64b88-157">对于更青睐 RStudio IDE 的分析员和数据科学家，可使用它高效提供对包含大量计算和内存容量的虚拟机的访问权限。</span><span class="sxs-lookup"><span data-stu-id="64b88-157">For analysts and data scientists who prefer the RStudio IDE, it can be an efficient option for providing access to virtual machine with a large compute and memory capacity.</span></span> <span data-ttu-id="64b88-158">可下载源版本和商业版。</span><span class="sxs-lookup"><span data-stu-id="64b88-158">It is available for download in both source and commercial editions.</span></span>

### <a name="azure-sql-database"></a><span data-ttu-id="64b88-159">Azure SQL 数据库</span><span class="sxs-lookup"><span data-stu-id="64b88-159">Azure SQL Database</span></span>

<span data-ttu-id="64b88-160">最初，订阅者数据存储在一个非常大的 .csv 文件中，具体包含 500 名唯一订阅者的 600 万行购买和偏好信息。</span><span class="sxs-lookup"><span data-stu-id="64b88-160">Originally, the subscriber data was stored in one very large .csv file with 6 million rows of purchasing and preference information for 500 unique subscribers.</span></span> <span data-ttu-id="64b88-161">将数据存储在数据库中意味着，可以更快地从 R 访问数据，并允许执行筛选读取。</span><span class="sxs-lookup"><span data-stu-id="64b88-161">Storing the data in a database meant faster data access from within R and it would allow for filtered reads.</span></span> <span data-ttu-id="64b88-162">无需再导入整个数据集以供定型或重新定型：数据由订阅者在数据库源处进行筛选，大大减少了导入和处理数据所需的资源。</span><span class="sxs-lookup"><span data-stu-id="64b88-162">No longer would the entire data set need to be imported for training or retraining: data would be filtered by subscriber at the database source, significantly reducing the resources needed to import and process the data.</span></span>  
<span data-ttu-id="64b88-163">Azure 中有多个托管云数据库选项。</span><span class="sxs-lookup"><span data-stu-id="64b88-163">There are several managed cloud database options in Azure.</span></span> <span data-ttu-id="64b88-164">之所以选择 [Azure SQL 数据库](https://docs.microsoft.com/azure/sql-database/)是因为，客户熟悉 SQL Server；更重要的是，未来计划将 SQL Server 机器学习服务更广泛地引入 Azure SQL 数据库。</span><span class="sxs-lookup"><span data-stu-id="64b88-164">[Azure SQL Database](https://docs.microsoft.com/azure/sql-database/) was selected because of the customer’s familiarity with SQL Server and—more importantly—future plans to introduce SQL Server Machine Learning Services on a broader scale to Azure SQL Database.</span></span> <span data-ttu-id="64b88-165">[SQL Server 机器学习服务](https://docs.microsoft.com/sql/advanced-analytics/what-is-sql-server-machine-learning?view=sql-server-2017)是数据库内置功能，用于通过存储过程执行 R 和 Python 工作负载。</span><span class="sxs-lookup"><span data-stu-id="64b88-165">[SQL Server Machine Learning Services](https://docs.microsoft.com/sql/advanced-analytics/what-is-sql-server-machine-learning?view=sql-server-2017) are in-database capabilities for executing R and Python workloads via stored procedures.</span></span>

### <a name="nodejs-and-reactjs"></a><span data-ttu-id="64b88-166">Node.js 和 React.js</span><span class="sxs-lookup"><span data-stu-id="64b88-166">Node.js and React.js</span></span>

<span data-ttu-id="64b88-167">创建 Web 接口是为了调用 R 脚本，并保护网站。</span><span class="sxs-lookup"><span data-stu-id="64b88-167">A web interface was created to invoke R scripts and secure the website.</span></span> <span data-ttu-id="64b88-168">之所以选择 Node.js 作为 Web 服务器框架是因为，它为分布式环境中的 Web 应用程序启用了轻型高效的运行时环境。</span><span class="sxs-lookup"><span data-stu-id="64b88-168">Node.js was selected as the web server framework because it enables a light-weight and efficient runtime environment for web applications within a distributed environment.</span></span> <span data-ttu-id="64b88-169">React 位于前端，用于生成用户界面，并调用 Web 服务器上托管的 Web 服务。</span><span class="sxs-lookup"><span data-stu-id="64b88-169">React is used to build user interfaces and sits on the front end and calls web services hosted on the web server.</span></span> <span data-ttu-id="64b88-170">Node + React 被认为是打造模型管道 Web 服务原型的最快速途径。</span><span class="sxs-lookup"><span data-stu-id="64b88-170">It was believed Node + React would provide the quickest path for proto-typing web services for the model pipeline.</span></span>  

## <a name="infrastructure-implementation"></a><span data-ttu-id="64b88-171">基础设施实现</span><span class="sxs-lookup"><span data-stu-id="64b88-171">Infrastructure implementation</span></span>

<span data-ttu-id="64b88-172">以下各部分介绍了此项目的服务器基础设施的部署方式。</span><span class="sxs-lookup"><span data-stu-id="64b88-172">The sections below describe how the server infrastructure was deployed for this project.</span></span> <span data-ttu-id="64b88-173">正确开发和部署基础设施与确定要应用的建模方法和技术同样至关重要。</span><span class="sxs-lookup"><span data-stu-id="64b88-173">Getting the right development and deployment infrastructure can be as essential as determining the modeling approach and techniques that will be applied.</span></span>

### <a name="initial-database-load"></a><span data-ttu-id="64b88-174">初始数据库加载</span><span class="sxs-lookup"><span data-stu-id="64b88-174">Initial Database Load</span></span>

<span data-ttu-id="64b88-175">第一步是，将非常大的 .csv 文件中的订阅者数据导入 Azure SQL 数据库。</span><span class="sxs-lookup"><span data-stu-id="64b88-175">The first step was to import the subscriber data from a very large .csv file into Azure SQL Database.</span></span> <span data-ttu-id="64b88-176">这篇[参考文章](https://blogs.msdn.microsoft.com/sqlcat/2010/07/30/loading-data-to-sql-azure-the-fast-way/)中介绍了多种将数据导入 Azure SQL 数据库的方法。</span><span class="sxs-lookup"><span data-stu-id="64b88-176">There are multiple options for importing data into Azure SQL Database described in in this [reference](https://blogs.msdn.microsoft.com/sqlcat/2010/07/30/loading-data-to-sql-azure-the-fast-way/).</span></span> <span data-ttu-id="64b88-177">我们采用的方法如下：</span><span class="sxs-lookup"><span data-stu-id="64b88-177">Here is how we did it:</span></span>

1. <span data-ttu-id="64b88-178">按照[此处](https://docs.microsoft.com/azure/sql-database/sql-database-get-started-portal)的步骤操作，通过 Azure 门户创建了数据库。</span><span class="sxs-lookup"><span data-stu-id="64b88-178">Created the database through Azure portal following steps [here](https://docs.microsoft.com/azure/sql-database/sql-database-get-started-portal).</span></span>
2. <span data-ttu-id="64b88-179">下载并使用 [SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017)，以从 VM 连接到数据库。</span><span class="sxs-lookup"><span data-stu-id="64b88-179">Downloaded and used [SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017) to connect to the database from the VM.</span></span>
3. <span data-ttu-id="64b88-180">选择了 [SQL 导入/导出向导](https://docs.microsoft.com/sql/integration-services/import-export-data/import-and-export-data-with-the-sql-server-import-and-export-wizard?view=sql-server-2017)（若有时间约束，可使用更多高性能数据导入选项）。</span><span class="sxs-lookup"><span data-stu-id="64b88-180">Selected the [SQL Import/Export Wizard](https://docs.microsoft.com/sql/integration-services/import-export-data/import-and-export-data-with-the-sql-server-import-and-export-wizard?view=sql-server-2017) (if you are time-constrained, there are more performant data import options).</span></span> <span data-ttu-id="64b88-181">请注意，导入/导出向导会将数据类型从数据源映射到目标位置；在我们的方案中，所有数据元素都映射到可接受的 varchar(max) 数据类型。</span><span class="sxs-lookup"><span data-stu-id="64b88-181">Keep in mind the import/export wizard maps datatypes from the data source to the target destination; and with our scenario, all data elements were mapped to a varchar(max) data type which was acceptable.</span></span> <span data-ttu-id="64b88-182">如果你的方案需要其他映射，可以在向导中修改数据类型（[参考文章](https://docs.microsoft.com/sql/integration-services/import-export-data/data-type-mapping-in-the-sql-server-import-and-export-wizard?view=sql-server-2017)）。</span><span class="sxs-lookup"><span data-stu-id="64b88-182">If your scenario requires different mappings, you can modify the datatypes in the wizard ([reference](https://docs.microsoft.com/sql/integration-services/import-export-data/data-type-mapping-in-the-sql-server-import-and-export-wizard?view=sql-server-2017)).</span></span>  
4. <span data-ttu-id="64b88-183">由于提交到数据库的大多数查询都按字段 subscriber_id 进行筛选，因此我们为此字段创建了索引。</span><span class="sxs-lookup"><span data-stu-id="64b88-183">Since most queries submitted to the database would filter on the field *subscriber_id*, we created an index on that field.</span></span>

### <a name="web-application"></a><span data-ttu-id="64b88-184">Web 应用程序</span><span class="sxs-lookup"><span data-stu-id="64b88-184">Web application</span></span>

<span data-ttu-id="64b88-185">Web 应用程序负责执行三个功能：</span><span class="sxs-lookup"><span data-stu-id="64b88-185">The web application is responsible for three functions:</span></span>

- <span data-ttu-id="64b88-186">身份验证：Web 用户通过 React 前端对 Azure Active Directory 进行身份验证。</span><span class="sxs-lookup"><span data-stu-id="64b88-186">Authentication: web users authenticate against *Azure Active Directory* through the *React* front end.</span></span>
- <span data-ttu-id="64b88-187">模型评分：接受用户提供的有关特定订阅者的输入数据，使用 REST API 将订阅者数据提交到 Web 服务，这会返回预测响应。</span><span class="sxs-lookup"><span data-stu-id="64b88-187">Model scoring: accepts input data from the user for a specific subscriber, submits the subscriber data to the web service using the REST API, which returns a prediction response.</span></span>  
- <span data-ttu-id="64b88-188">模型重新定型：接受订阅者标识符作为输入，并对开发服务器调用 R 脚本，以重新定型相应订阅者的模型。</span><span class="sxs-lookup"><span data-stu-id="64b88-188">Model re-training: accepts a subscriber identifier as input an,d invokes an R script on the development server to re-train the model for that subscriber.</span></span>

<span data-ttu-id="64b88-189">使用 Azure Active Directory 实现单一登录 (SSO) 比预期更具挑战性。</span><span class="sxs-lookup"><span data-stu-id="64b88-189">Implementing single sign-on (SSO) with *Azure Active Directory* turned out to be more of a challenge than expected.</span></span> <span data-ttu-id="64b88-190">这是由于单页应用程序 (SPA) 框架所致。</span><span class="sxs-lookup"><span data-stu-id="64b88-190">This was due to the single page application (SPA) framework.</span></span> <span data-ttu-id="64b88-191">一个 Azure Active Directory 库是取得成功的关键，就是 [react adal](https://github.com/salvoravida/react-adal)。</span><span class="sxs-lookup"><span data-stu-id="64b88-191">One specific Azure Active Directory library was key for success: [react-adal](https://github.com/salvoravida/react-adal).</span></span> <span data-ttu-id="64b88-192">下面的参考文章提供了有关实现身份验证的实用指南：</span><span class="sxs-lookup"><span data-stu-id="64b88-192">The following references provided helpful guidance for implementing authentication:</span></span>

- [<span data-ttu-id="64b88-193">Azure AD 的身份验证方案</span><span class="sxs-lookup"><span data-stu-id="64b88-193">Authentication Scenarios for Azure AD</span></span>](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios)
- [<span data-ttu-id="64b88-194">单页应用程序</span><span class="sxs-lookup"><span data-stu-id="64b88-194">Single Page Application</span></span>](https://docs.microsoft.com/azure/active-directory/develop/active-directory-authentication-scenarios#single-page-application-spa)

### <a name="development-vm-mls-930"></a><span data-ttu-id="64b88-195">开发 VM (MLS 9.3.0)</span><span class="sxs-lookup"><span data-stu-id="64b88-195">Development VM (MLS 9.3.0)</span></span>

<span data-ttu-id="64b88-196">开发 VM 托管了模型开发、定型和重新定型以及分类模型部署。</span><span class="sxs-lookup"><span data-stu-id="64b88-196">The development VM hosted model development, training and re-training, and deployment of the classification model.</span></span> <span data-ttu-id="64b88-197">Azure VM (DS13 V2) 预配有 Linux/Ubuntu 16.10，并将以下内容安装到基础 VM 上：</span><span class="sxs-lookup"><span data-stu-id="64b88-197">An Azure VM (DS13 V2) was provisioned with Linux/Ubuntu 16.10 and the following were installed to the base VM:</span></span>

- <span data-ttu-id="64b88-198">Machine Learning Server 9.3.0（有关说明，请单击[此处](https://docs.microsoft.com/machine-learning-server/install/machine-learning-server-install)）。</span><span class="sxs-lookup"><span data-stu-id="64b88-198">Machine Learning Server 9.3.0 using instructions available [here](https://docs.microsoft.com/machine-learning-server/install/machine-learning-server-install).</span></span> <span data-ttu-id="64b88-199">请务必完成创建验证步骤，以确认是否安装。</span><span class="sxs-lookup"><span data-stu-id="64b88-199">Be sure to run through the setup verification steps to confirm the installation.</span></span> <span data-ttu-id="64b88-200">由于这是开发 VM，我们忽略了“启用 Web 服务部署和远程连接”部分。</span><span class="sxs-lookup"><span data-stu-id="64b88-200">Because this was the development VM, the section ‘*Enable web service deployment and remote connections*’ was disregarded.</span></span>
- <span data-ttu-id="64b88-201">[RStudio Server](https://www.rstudio.com/products/rstudio/download-server/)（开放源代码版本）。</span><span class="sxs-lookup"><span data-stu-id="64b88-201">[RStudio Server](https://www.rstudio.com/products/rstudio/download-server/) (Open Source Version).</span></span> <span data-ttu-id="64b88-202">请注意，不要重新安装 R/r-base（之前已与 MLS 9.3.0 一起安装）。</span><span class="sxs-lookup"><span data-stu-id="64b88-202">Be careful not to re-install R/r-base (it was installed previously with MLS 9.3.0).</span></span>  
- <span data-ttu-id="64b88-203">[将网络安全组添加到](https://docs.microsoft.com/azure/virtual-machines/windows/nsg-quickstart-portal) VM，以便能够通过端口 8787 为 RStudio Server 实现入站连接。</span><span class="sxs-lookup"><span data-stu-id="64b88-203">[Add a network security group](https://docs.microsoft.com/azure/virtual-machines/windows/nsg-quickstart-portal) to the VM to allow for inbound connections over port 8787 for RStudio Server.</span></span>  
- <span data-ttu-id="64b88-204">ODBC 驱动程序，用于处理开发 VM 和 Azure SQL 数据库之间的通信。</span><span class="sxs-lookup"><span data-stu-id="64b88-204">ODBC drivers to handle the communication between the development VM and Azure SQL Database.</span></span> <span data-ttu-id="64b88-205">VM 上安装了以下 odbc 驱动程序：</span><span class="sxs-lookup"><span data-stu-id="64b88-205">The following odbc drivers were installed on the VM:</span></span>  
- <span data-ttu-id="64b88-206">与 Linux/ubuntu 16.10 兼容的 [ODBC Driver for SQL Server 17](https://www.microsoft.com/download/details.aspx?id=56567)</span><span class="sxs-lookup"><span data-stu-id="64b88-206">The [ODBC Driver for SQL Server 17](https://www.microsoft.com/download/details.aspx?id=56567) compatible with Linux/ubuntu 16.10</span></span>  
- <span data-ttu-id="64b88-207">开放源代码 ODBC 驱动程序 unixodbc（有关安装说明，请参阅[使用 ODBC 导入关系数据](https://docs.microsoft.com/machine-learning-server/r/how-to-revoscaler-data-odbc)）。</span><span class="sxs-lookup"><span data-stu-id="64b88-207">An open source ODBC driver unixodbc with installation instructions from [Import relational data using ODBC](https://docs.microsoft.com/machine-learning-server/r/how-to-revoscaler-data-odbc).</span></span> <span data-ttu-id="64b88-208">注意：这篇文章中的 Ubuntu 说明有两个拼写错误。</span><span class="sxs-lookup"><span data-stu-id="64b88-208">Note: this article has two typos for Ubuntu instructions.</span></span>  
- <span data-ttu-id="64b88-209">若要检查 unixodbc 是否已安装，请运行以下命令：       ````Apt list –installed | grep unixODBC (should be unixodbc)````</span><span class="sxs-lookup"><span data-stu-id="64b88-209">To check if unixodbc is installed:       ````Apt list –installed | grep unixODBC (should be unixodbc)````</span></span>
      - <span data-ttu-id="64b88-210">若要安装此驱动程序，请运行以下命令：````sudo apt-get install unixodbc-devel unixodbc-bin unixodbc (should be unixodbc-dev)````</span><span class="sxs-lookup"><span data-stu-id="64b88-210">And to install the driver: ````sudo apt-get install unixodbc-devel unixodbc-bin unixodbc (should be unixodbc-dev)````</span></span>

### <a name="operations-vm-mls-930"></a><span data-ttu-id="64b88-211">运营 VM (MLS 9.3.0)</span><span class="sxs-lookup"><span data-stu-id="64b88-211">Operations VM (MLS 9.3.0)</span></span>

<span data-ttu-id="64b88-212">运营 VM 托管了模型 Web 服务和终结点，存储了 Swagger 文件和分类模型的序列化版本。</span><span class="sxs-lookup"><span data-stu-id="64b88-212">The operations VM hosted the model web services and endpoints, stored the Swagger files, and stored serialized versions of the classification models.</span></span> <span data-ttu-id="64b88-213">配置非常类似于 MLS 开发服务器。</span><span class="sxs-lookup"><span data-stu-id="64b88-213">Configuration is very similar to the MLS development server.</span></span> <span data-ttu-id="64b88-214">不过，它配置为用于运营化。也就是说，为 REST 终结点提供服务所需的 Web 服务已安装。</span><span class="sxs-lookup"><span data-stu-id="64b88-214">However, it is configured for operationalization which means the web services necessary to serve the REST endpoints are installed.</span></span> <span data-ttu-id="64b88-215">若要部署运营 VM，可使用 ARM 模板进行快速部署。</span><span class="sxs-lookup"><span data-stu-id="64b88-215">To deploy the operations VM, there are ARM templates that make deployment quick.</span></span> <span data-ttu-id="64b88-216">请参阅[使用 ARM 模板将 Microsoft Machine Learning Server 9.3 配置为对分析进行运管化](https://blogs.msdn.microsoft.com/mlserver/2018/02/27/configuring-microsoft-machine-learning-server-9-3-to-operationalize-analytics-using-arm-templates/)。</span><span class="sxs-lookup"><span data-stu-id="64b88-216">See: [Configuring Microsoft Machine Learning Server 9.3 to Operationalize Analytics using ARM Templates](https://blogs.msdn.microsoft.com/mlserver/2018/02/27/configuring-microsoft-machine-learning-server-9-3-to-operationalize-analytics-using-arm-templates/).</span></span> <span data-ttu-id="64b88-217">我们的项目使用此 [ARM 模板](https://github.com/Microsoft/microsoft-r/tree/master/mlserver-arm-templates/one-box-configuration/linux)部署了一体化配置。</span><span class="sxs-lookup"><span data-stu-id="64b88-217">For our project, a *One-Box* configuration was deployed using this [ARM template](https://github.com/Microsoft/microsoft-r/tree/master/mlserver-arm-templates/one-box-configuration/linux).</span></span>  
<span data-ttu-id="64b88-218">这样一来，支持模型管道的服务器组件便能正常运行了。</span><span class="sxs-lookup"><span data-stu-id="64b88-218">With this, the server components to support the model pipeline were up and running.</span></span>

## <a name="model-implementation"></a><span data-ttu-id="64b88-219">模型实现</span><span class="sxs-lookup"><span data-stu-id="64b88-219">Model implementation</span></span>

<span data-ttu-id="64b88-220">一项关键决策影响了此项目的最终模型设计，即迁移到“多模型”设计，而不是单一整体模型。</span><span class="sxs-lookup"><span data-stu-id="64b88-220">One key decision influenced the final model design for this project and that was to move to a “many model” design rather than a single, monolithic model.</span></span> <span data-ttu-id="64b88-221">两者的区别在于，每个订阅者都有自己的分类模型，而不是使用一个大型分类模型为所有订阅者提供服务。</span><span class="sxs-lookup"><span data-stu-id="64b88-221">The difference: each subscriber has their own classification model rather than one big classification model to serve all subscribers.</span></span> <span data-ttu-id="64b88-222">对于这位客户而言，之所以首选这种方法是因为，较小模型的内存占用情况也较小，并且更易于在生产中实现横向扩展。</span><span class="sxs-lookup"><span data-stu-id="64b88-222">For this customer, the approach was preferred because a smaller model had a smaller memory footprint and was easier to scale horizontally in production.</span></span>

### <a name="data-import"></a><span data-ttu-id="64b88-223">数据导入</span><span class="sxs-lookup"><span data-stu-id="64b88-223">Data import</span></span>

<span data-ttu-id="64b88-224">模型开发所需的全部数据都驻留在 Azure SQL 数据库中。</span><span class="sxs-lookup"><span data-stu-id="64b88-224">All the data needed for model development resided in an *Azure SQL Database*.</span></span> <span data-ttu-id="64b88-225">对于模型定型和重新定型，数据导入分两个阶段完成：</span><span class="sxs-lookup"><span data-stu-id="64b88-225">For model training and retraining, data import was done in two stages:</span></span>

1. <span data-ttu-id="64b88-226">将查询提交到数据库，以检索特定 subscriber_id 的数据和返回的结果集。</span><span class="sxs-lookup"><span data-stu-id="64b88-226">A query was submitted to the database to retrieve data for a specific *subscriber_id* and a result set returned.</span></span> <span data-ttu-id="64b88-227">为了对数据库进行查询访问，我们考虑了以下两种方法：</span><span class="sxs-lookup"><span data-stu-id="64b88-227">Two options were considered for query access to the database:</span></span>

- <span data-ttu-id="64b88-228">名为 [RxSQLServerData](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxsqlserverdata) 的 RevoScaleR 函数</span><span class="sxs-lookup"><span data-stu-id="64b88-228">A RevoScaleR function called [RxSQLServerData](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxsqlserverdata)</span></span>
- <span data-ttu-id="64b88-229">R odbc 包</span><span class="sxs-lookup"><span data-stu-id="64b88-229">The R odbc package</span></span>

<span data-ttu-id="64b88-230">最终决定使用在数据库一级启用了数据筛选的 R odbc 库。</span><span class="sxs-lookup"><span data-stu-id="64b88-230">It was decided to use the R “odbc” library which enabled data filtering at the database level.</span></span> <span data-ttu-id="64b88-231">从数据库表中仅筛选出特定订阅者模型所需的行，最大程度地减少了要读入 R 并处理的行数。</span><span class="sxs-lookup"><span data-stu-id="64b88-231">Filtering the database table for only the rows needed for a specific subscriber model minimized the number of rows to be read into R and processed.</span></span> <span data-ttu-id="64b88-232">这还减少了定型或重新定型每个模型所需的内存、计算和总时间。</span><span class="sxs-lookup"><span data-stu-id="64b88-232">That reduced the memory, compute, and overall time needed to train or retrain each model.</span></span>  

1. <span data-ttu-id="64b88-233">将结果集转换为 R 数据帧，并按分类算法要求，将一些数据类型从 varchars 显式转换为整数或数字。</span><span class="sxs-lookup"><span data-stu-id="64b88-233">The result set was converted into an R data frame and some of the data types were explicitly converted from varchars to integers or numerics as required by the classification algorithms.</span></span> <span data-ttu-id="64b88-234">对于此功能，使用的是 RevoScaleR 函数 [rxImport](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rximport)。</span><span class="sxs-lookup"><span data-stu-id="64b88-234">For this functionality, the RevoScaleR function [rxImport](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rximport) was used.</span></span> <span data-ttu-id="64b88-235">rxImport 函数与 RevoScaleR 和 MicrosoftML 捆绑在一起，设计为采用多线程。</span><span class="sxs-lookup"><span data-stu-id="64b88-235">The *rxImport* function is bundled with RevoScaleR and MicrosoftML and is engineered to be multi-threaded.</span></span> <span data-ttu-id="64b88-236">下面的示例展示了我们是如何使用它的：</span><span class="sxs-lookup"><span data-stu-id="64b88-236">Here is an example of how we used it:</span></span>

````r

# Populate the data frame and modify column types as needed
input_data <- rxImport(sqlServerDataDS, colClasses = c(  
Approved="integer",
      OnTimeArrivalRate="numeric",
      Amount="numeric",
      IsInformed="numeric",
      <continue with list of columns> )
# View the characteristics of the variables in the data source
rxGetInfo (input_data, getVarInfo = TRUE)
````

## <a name="unbalanced-data"></a><span data-ttu-id="64b88-237">非均衡数据</span><span class="sxs-lookup"><span data-stu-id="64b88-237">Unbalanced data</span></span>

<span data-ttu-id="64b88-238">因为推荐模型的目标是预测客户续订合同的概率，并将概率分类为“是”、“否”或“可能”，所以使用了分类算法。</span><span class="sxs-lookup"><span data-stu-id="64b88-238">Because the goal of the recommendation model was to forecast the probability a customer would renew a contract and categorize the probability it into a ‘yes’, ‘no’, or ‘maybe’, a classification algorithm was used.</span></span> <span data-ttu-id="64b88-239">非均衡数据集可能会严重影响分类算法的准确度和性能。</span><span class="sxs-lookup"><span data-stu-id="64b88-239">One problem that can seriously impact the accuracy and performance of a classification algorithm is an unbalanced data set.</span></span>  
<span data-ttu-id="64b88-240">如果一个“分类”的样本多于另一个“分类”，那么数据集就是非均衡。</span><span class="sxs-lookup"><span data-stu-id="64b88-240">A data set is unbalanced if there are many more samples for one ‘class’ than another ‘class’.</span></span> <span data-ttu-id="64b88-241">在这种情况下，对每个订阅者可用的行数是非均衡的：在高端，一个订阅者有超过 100 万行；在低端，330 个订阅者有不到 100 数据行。</span><span class="sxs-lookup"><span data-stu-id="64b88-241">In this case, the number of rows available for each subscriber was unbalanced: on the high end, one subscriber had 1 million+ rows; on the low end, 330 customers had less than 100 rows of data.</span></span> <span data-ttu-id="64b88-242">下图展示了每个订阅者的行数（样本）非均衡性：![非均衡性图表](assets/recommendation-engine-optimization/recommendaton_engine_chart.png)</span><span class="sxs-lookup"><span data-stu-id="64b88-242">The graph below shows the imbalance with the number of rows (samples) per subscriber: ![imbalance-chart](assets/recommendation-engine-optimization/recommendaton_engine_chart.png)</span></span>

<span data-ttu-id="64b88-243">处理非均衡数据集的一种技术是，更改数据集，并对代表性不足的分类进行过采样，或对代表性过度的分类进行降采样。</span><span class="sxs-lookup"><span data-stu-id="64b88-243">One technique for treating an unbalanced data set is to change the data set and either over-sample the under-represented class, or under-sample the over-represented class.</span></span> <span data-ttu-id="64b88-244">另一种技术是，利用数据所有者对数据及其属性的确切知识来综合生成附加数据。</span><span class="sxs-lookup"><span data-stu-id="64b88-244">Another technique is to synthetically generate additional data using the data owner’s exact knowledge of the data and its attributes.</span></span> <span data-ttu-id="64b88-245">这位客户建立了订阅者的最小样本量阈值。</span><span class="sxs-lookup"><span data-stu-id="64b88-245">The customer established a threshold for the minimum sample size for a subscriber.</span></span> <span data-ttu-id="64b88-246">对于低于此阈值的订阅者，需要处理数据。</span><span class="sxs-lookup"><span data-stu-id="64b88-246">For subscribers below that threshold, data would need to be treated.</span></span> <span data-ttu-id="64b88-247">此项目对这两种方法都有探索。</span><span class="sxs-lookup"><span data-stu-id="64b88-247">For this project both approaches were explored.</span></span>

## <a name="algorithm-selection"></a><span data-ttu-id="64b88-248">算法选择</span><span class="sxs-lookup"><span data-stu-id="64b88-248">Algorithm Selection</span></span>

<span data-ttu-id="64b88-249">我们评估了三种不同的分类算法实现：rxDForest、rxFastTrees 和 rxFastForest。</span><span class="sxs-lookup"><span data-stu-id="64b88-249">Three different classification algorithm implementations were evaluated: *rxDForest*, *rxFastTrees*, and *rxFastForest*.</span></span> <span data-ttu-id="64b88-250">所有这三种算法都利用了多线程和并行度。</span><span class="sxs-lookup"><span data-stu-id="64b88-250">All three algorithms take advantage of multi-threading and parallelism.</span></span> <span data-ttu-id="64b88-251">Microsoft ML 将使用多个 CPU 或 GPU（若有）。</span><span class="sxs-lookup"><span data-stu-id="64b88-251">And Microsoft ML will use multiple CPUs or GPUs if available.</span></span> <span data-ttu-id="64b88-252">模型评估标准包括：</span><span class="sxs-lookup"><span data-stu-id="64b88-252">The criteria for evaluating the models included:</span></span>

- <span data-ttu-id="64b88-253">新模型比原始模型更准确吗？</span><span class="sxs-lookup"><span data-stu-id="64b88-253">Were the new models more accurate that the original model?</span></span>
- <span data-ttu-id="64b88-254">生产中运行的模型的内存占用情况是多少？</span><span class="sxs-lookup"><span data-stu-id="64b88-254">What was the memory footprint of the models running in production?</span></span> <span data-ttu-id="64b88-255">在不影响准确度的情况下，运营环境是否支持同时执行多个准实时返回预测响应的模型？</span><span class="sxs-lookup"><span data-stu-id="64b88-255">Without compromising accuracy, could the operational environment support simultaneous execution of many models with near real-time prediction response?</span></span>
- <span data-ttu-id="64b88-256">算法处理非均衡数据集的效果如何？</span><span class="sxs-lookup"><span data-stu-id="64b88-256">How well did the algorithm handle the unbalanced data set?</span></span> <span data-ttu-id="64b88-257">是否需要通过生成综合数据来预处理非均衡性？</span><span class="sxs-lookup"><span data-stu-id="64b88-257">Would the imbalance need to be pre-treated by generating synthetic data?</span></span>

<span data-ttu-id="64b88-258">下表汇总了调查结果：</span><span class="sxs-lookup"><span data-stu-id="64b88-258">The table below summarizes the findings:</span></span>

| <span data-ttu-id="64b88-259">算法</span><span class="sxs-lookup"><span data-stu-id="64b88-259">Algorithm</span></span> | <span data-ttu-id="64b88-260">Description</span><span class="sxs-lookup"><span data-stu-id="64b88-260">Description</span></span> | <span data-ttu-id="64b88-261">调查结果</span><span class="sxs-lookup"><span data-stu-id="64b88-261">Findings</span></span> | <span data-ttu-id="64b88-262">说明</span><span class="sxs-lookup"><span data-stu-id="64b88-262">Notes</span></span> |
| :--------- | :------------ | :--------- | :--------------- |
| [<span data-ttu-id="64b88-263">rxFastTrees</span><span class="sxs-lookup"><span data-stu-id="64b88-263">rxFastTrees</span></span>](https://docs.microsoft.com/machine-learning-server/r-reference/microsoftml/rxfasttrees) | <span data-ttu-id="64b88-264">并行实现已提升决策树，以实现 FastRank 的多线程版本。</span><span class="sxs-lookup"><span data-stu-id="64b88-264">Parallel implementation of boosted decision tree that implements multi-threaded version of FastRank.</span></span> | <span data-ttu-id="64b88-265">准确且性能速度最快。</span><span class="sxs-lookup"><span data-stu-id="64b88-265">Accurate, fastest performance.</span></span> | <span data-ttu-id="64b88-266">没有针对非均衡数据的特殊功能。</span><span class="sxs-lookup"><span data-stu-id="64b88-266">No special features for unbalanced data.</span></span> <span data-ttu-id="64b88-267">需要提供预处理数据作为输入</span><span class="sxs-lookup"><span data-stu-id="64b88-267">Pre-treated data needed to be provided as input</span></span> |
| [<span data-ttu-id="64b88-268">rxFastForest</span><span class="sxs-lookup"><span data-stu-id="64b88-268">rxFastForest</span></span>](https://docs.microsoft.com/machine-learning-server/r-reference/microsoftml/rxfastforest) | <span data-ttu-id="64b88-269">并行实现随机林，并使用 rxFastTrees 生成决策树的集成学习器。</span><span class="sxs-lookup"><span data-stu-id="64b88-269">Parallel implementation of random forest and uses rxFastTrees to build an ensemble learner of decision trees.</span></span> | <span data-ttu-id="64b88-270">使用预处理数据后比原始模型更准确。</span><span class="sxs-lookup"><span data-stu-id="64b88-270">Better accuracy than original with pre-treated data.</span></span> <span data-ttu-id="64b88-271">更少占用大量内存，比 rxDForest 更快</span><span class="sxs-lookup"><span data-stu-id="64b88-271">Less memory intensive, faster than rxDForest</span></span> |<span data-ttu-id="64b88-272">没有针对非均衡数据的特殊功能。</span><span class="sxs-lookup"><span data-stu-id="64b88-272">No special features for unbalanced data.</span></span> <span data-ttu-id="64b88-273">需要提供预处理数据作为输入。</span><span class="sxs-lookup"><span data-stu-id="64b88-273">Pre-treated data provided as input.</span></span> |
| [<span data-ttu-id="64b88-274">rxDForest</span><span class="sxs-lookup"><span data-stu-id="64b88-274">rxDForest</span></span>](https://docs.microsoft.com/machine-learning-server/r-reference/revoscaler/rxdforest) | <span data-ttu-id="64b88-275">并行实现随机林。</span><span class="sxs-lookup"><span data-stu-id="64b88-275">Parallel implementation of random forest.</span></span> <span data-ttu-id="64b88-276">包含在 RevoScaleR 中。</span><span class="sxs-lookup"><span data-stu-id="64b88-276">Included in RevoScaleR.</span></span> <span data-ttu-id="64b88-277">可以仅在函数调用中就处理非均衡数据（删除缺失数据、为数据设置条件和处理样本分层）。</span><span class="sxs-lookup"><span data-stu-id="64b88-277">Can deal with unbalanced data (removes missing data, conditions data, handles stratification of samples) all within the function call.</span></span> | <span data-ttu-id="64b88-278">比原始模型更快。</span><span class="sxs-lookup"><span data-stu-id="64b88-278">Faster than original model.</span></span> <span data-ttu-id="64b88-279">与原始模型一样准确或更准确。</span><span class="sxs-lookup"><span data-stu-id="64b88-279">Same or better accuracy than original model.</span></span> <span data-ttu-id="64b88-280">使用各种重新采样和综合技术来处理非均衡数据集。</span><span class="sxs-lookup"><span data-stu-id="64b88-280">Handles unbalanced data set using a variety of techniques for re-sampling and synthesizing.</span></span> <span data-ttu-id="64b88-281">内存占用情况最大。</span><span class="sxs-lookup"><span data-stu-id="64b88-281">Largest memory footprint.</span></span>  | <span data-ttu-id="64b88-282">内存占用情况最大是因为，它在函数内包含有条件的数据。</span><span class="sxs-lookup"><span data-stu-id="64b88-282">Largest memory footprint because it includes the conditioned data within the function.</span></span>   <span data-ttu-id="64b88-283">虽然数据处理的效果很好，但不如数据所有者提供的自定义转换效果好。</span><span class="sxs-lookup"><span data-stu-id="64b88-283">Treatment of the data was good but not as good as the customized transformations provided by the data owner.</span></span> |

<span data-ttu-id="64b88-284">最后，这位客户选择了 rxFastForest 算法，并决定使用 [vtreat](https://cran.r-project.org/web/packages/vtreat/index.html) 库和添加自定义数据预处理步骤，以为代表性不足的订阅者综合生成数据，从而处理非均衡数据。</span><span class="sxs-lookup"><span data-stu-id="64b88-284">In the end, the customer selected the *rxFastForest* algorithm and decided to treat the unbalanced data by using the [vtreat](https://cran.r-project.org/web/packages/vtreat/index.html) library and adding a customized data pre-processing step to synthetically generate data for the under-represented subscribers.</span></span>

## <a name="model-deployment--web-services"></a><span data-ttu-id="64b88-285">模型部署和 Web 服务</span><span class="sxs-lookup"><span data-stu-id="64b88-285">Model Deployment & Web Services</span></span>

<span data-ttu-id="64b88-286">发布模型以供部署到运营 VM 是很容易的，[使用 mrsdeploy 将 R 模型部署为 Web 服务](https://docs.microsoft.com/machine-learning-server/operationalize/quickstart-publish-r-web-service)这篇快速入门文档中进行了说明。</span><span class="sxs-lookup"><span data-stu-id="64b88-286">Publishing a model for deployment to the operations VM is straight-forward and documented in this QuickStart documentation [Deploy an R Model as a web service with mrsdeploy](https://docs.microsoft.com/machine-learning-server/operationalize/quickstart-publish-r-web-service).</span></span>
<span data-ttu-id="64b88-287">在我们的方案中，在开发 VM 上创建模型后，我们就会按以下步骤操作，在运营 VM 上发布它们：</span><span class="sxs-lookup"><span data-stu-id="64b88-287">In our scenario, once the models were created on the development VM, they were published on the operations VM using these steps:</span></span>

1. <span data-ttu-id="64b88-288">使用 mrsdeploy 包中的两个身份验证函数之一，建立从开发 VM 到运营 VM 的远程登录：使用本地管理员名称和密码的 remoteLogin()，或使用 Azure Active Directory 的 remoteLoginAAD()。</span><span class="sxs-lookup"><span data-stu-id="64b88-288">Establish a remote login from the developer VM to the operations VM using one of two functions available in the mrsdeploy package for authentication; remoteLogin() using a local admin name and password, or remoteLoginAAD() using Azure Active Directory.</span></span> <span data-ttu-id="64b88-289">“使用 mrsdeploy 登录 Machine Learning Server 或 R Server”这篇参考文章中介绍了这两个选项，它们都打开远程会话。</span><span class="sxs-lookup"><span data-stu-id="64b88-289">Both options are described in this reference Log in to Machine Learning Server or R Server with mrsdeploy and open a remote session.</span></span>  
2. <span data-ttu-id="64b88-290">模型定型后，立即使用 mrsdeploy 包中的 publishService 或 updateService 函数，将模型发布到运营 VM。</span><span class="sxs-lookup"><span data-stu-id="64b88-290">Once a model is trained, publish it to the operations VM using the publishService or updateService functions in the mrsdeploy package.</span></span> <span data-ttu-id="64b88-291">对于这个项目，我们使用了多种部署方法，具体是发布新模型还是更新现有模型视所选方法而定。</span><span class="sxs-lookup"><span data-stu-id="64b88-291">For this project, we used multiple deployment approaches, and—depending on the approach—either a new model was published, or an existing model was updated.</span></span> <span data-ttu-id="64b88-292">为了处理这两种情况，我们实现了以下代码：</span><span class="sxs-lookup"><span data-stu-id="64b88-292">The following code was implemented to handle both cases:</span></span>

````r
# If the service does not exist, publish it and if it does exist, update it.  
# No service by this name so publish one
 api <- publishService(serviceName, code =sc_predict, model = model,  
      inputs = list(prop_data="data.frame"),  
      outputs = list(answer = "numeric"), v = "v1.0.0" )
 print("=========== Model Created =============")
} else {
# A service by this name already exists, update it  
 api <- updateService(serviceName, model = model,
     inputs = list(prop_data="data.frame"), v = "v1.0.0" )
 print("=========== Model Updated =============")
}
 ````

部署后，模型就会进行序列化，并存储在运营服务器上，可通过处于标准或实时模式下的 Web 服务进行使用。 每当调用的是处于标准模式下的 Web 服务时，R 和所需的任何库都会随每次调用一起加载和卸载。 相比之下，对于实时模式，R 和库只加载一次，并可重用于后续 Web 服务调用。 由于 Web 服务调用的大部分开销是加载 R 和库，因此实时模式的模型评分延迟更低，响应时间不到 10ms。 有关标准和实时模式，请参阅[此处](https://docs.microsoft.com/machine-learning-server/operationalize/concept-what-are-web-services)的文档和参考示例。 虽然实时模式适用于单一预测，但也可以传入输入数据帧以用于评分。 <span data-ttu-id="64b88-299">下面这篇参考文章中对此进行了介绍：[使用 mrsdeploy 通过批处理来使用异步 Web 服务](https://docs.microsoft.com/machine-learning-server/operationalize/how-to-consume-web-service-asynchronously-batch)。</span><span class="sxs-lookup"><span data-stu-id="64b88-299">That is described in this reference: [Asynchronous web service consumption via batch processing with mrsdeploy](https://docs.microsoft.com/machine-learning-server/operationalize/how-to-consume-web-service-asynchronously-batch).</span></span>

## <a name="conclusion"></a><span data-ttu-id="64b88-300">结束语</span><span class="sxs-lookup"><span data-stu-id="64b88-300">Conclusion</span></span>

<span data-ttu-id="64b88-301">利用 Microsoft Machine Learning Server 中内置的 MicrosoftML 和 RevoScaleR 库的并行度，我们加速了数百个订阅者的各个分类模型的开发、部署和评分。</span><span class="sxs-lookup"><span data-stu-id="64b88-301">Leveraging the parallelism of the MicrosoftML and RevoScaleR libraries built into Microsoft Machine Learning Server accelerated development, deployment, and scoring of individual classification models for hundreds of subscribers.</span></span> <span data-ttu-id="64b88-302">模型准确度有所提升，定型和重新定型时间有所缩短，所有这些都只需对现有 R 基准代码进行极少更改。</span><span class="sxs-lookup"><span data-stu-id="64b88-302">Model accuracy improved, and training and re-training times were compressed—all with minimal changes to the existing R code base.</span></span>
<span data-ttu-id="64b88-303">复杂的是，实现基础设施以支持模型管道，并对技术组件进行正确端到端配置。</span><span class="sxs-lookup"><span data-stu-id="64b88-303">Implementing the infrastructure to support a model pipeline and getting the technology components configured correctly end-to-end can be complex.</span></span> <span data-ttu-id="64b88-304">若要开始使用你自己的方法，请参阅下面的一些参考文章：</span><span class="sxs-lookup"><span data-stu-id="64b88-304">Here are some references to get your started with your own approach:</span></span>

- [<span data-ttu-id="64b88-305">Machine Learning Server 文档</span><span class="sxs-lookup"><span data-stu-id="64b88-305">Machine Learning Server Documentation</span></span>](https://docs.microsoft.com/machine-learning-server/)
- [<span data-ttu-id="64b88-306">适用于 Machine Learning Server 的 R 教程</span><span class="sxs-lookup"><span data-stu-id="64b88-306">R Tutorials for Machine Learning Server</span></span>](https://docs.microsoft.com/advanced-analytics/tutorials/sql-server-r-tutorials?view=sql-server-2017)
- [<span data-ttu-id="64b88-307">适用于 Machine Learning Server 的 R 示例</span><span class="sxs-lookup"><span data-stu-id="64b88-307">R Samples for Machine Learning Server</span></span>](https://docs.microsoft.com/machine-learning-server/r/r-samples)
- [<span data-ttu-id="64b88-308">R 函数库参考</span><span class="sxs-lookup"><span data-stu-id="64b88-308">R Function Library Reference</span></span>](https://docs.microsoft.com/machine-learning-server/r-reference/introducing-r-server-r-package-reference)

## <a name="references"></a><span data-ttu-id="64b88-309">参考</span><span class="sxs-lookup"><span data-stu-id="64b88-309">References</span></span>

<span data-ttu-id="64b88-310">若对构建零售业务的其他预测解决方案感兴趣，请访问 Azure [AI 库](https://gallery.azure.ai/)的[零售部分](https://gallery.azure.ai/industries/retail)。</span><span class="sxs-lookup"><span data-stu-id="64b88-310">If you are interested in building other predictive solutions for your retail business, visit the [retail section](https://gallery.azure.ai/industries/retail) of the Azure [AI Gallery](https://gallery.azure.ai/).</span></span>  